---
title: "Muscle_progenitors_single_cell_validations"
author: "Jordi Camps"
date: "October 24, 2017"
output: html_document
---


# Load librararies
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(qpcrviia7)
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggthemes)
library(RColorBrewer)
```

# Import and prepare data
```{r}
#Import data
qpcr <- read_qpcr("Data/2017-09-20 124839 FAP-C2C12-Muscle qPCR validation MC.xls", sheet = 3)
#Import annotation
ann_samples <- read_annotation("Data/Annotations_124839_samples.xlsx")
ann_genes <- read_annotation("/home/jordi/stack/PhD/Results/Muscle progenitors/Validations/Decorin (Marlies project)/Annotations_124839_primers.xlsx")


#Merge and tidy
join_and_clean_qpcr(qpcr)
```

## Quality control
### Primers and samples
```{r}
par(mfrow=c(1,1))
hist(qpcr$CT, main = "CT values")

#Plot CT values for samples
ggplot(qpcr, aes(Sample, CT)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("CT values per sample")

#Plot CT values for primers
ggplot(qpcr, aes(Gene, CT)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("CT values per primer")
```

#### Remove blanc and split endogenous and housekeeping genes
```{r}
#Remove blanc
remove_sample(qpcr, "Sample 23")
hist(qpcr$CT, main = "CT after removal blanc")
```

#### Split hkg from endogenous
```{r}
split_genes(qpcr)
```


### Endogenous genes
```{r}
#Set min and max ct value
endog <- set_min_max_CT( endog, 10, 40)
hist(endog$CT, main = "CT after set baseline")

#Double meltcurve peaks
list_double_meltcurves(endog)
remove_bad_meltcurves()
```

### Housekeeping genes
```{r}
#QC on housekeeping genes
qc_hkg(hkg)
```

#### Remove Rpl13a
```{r}
remove_primer(endog, "Rpl13a")
```


#### Take geometric average all housekeeping genes
```{r}
mean_hkg <- calculate_mean_hkg(hkg)
qc_mean_hkg(hkg)
```

#### Remove outliers
```{r}
mean_hkg$CT_avg_hkg <- remove_outliers(mean_hkg$CT_avg_hkg)
```


## Delta CT
### Calculate Delta CT
```{r}
calculate_DCT(endog, mean_hkg, cols = c("Cell_type", "Condition", "Mouse"))
```

### Plot Delta CT
#### Scatter plot
```{r}
plot_scatter(endog, x.var = "Cell_type", y.var = "DCt", col.var = "Condition") +
  ggsave("Plots/all_genes.tiff", width = 30, height = 21, units = "cm")
plot_scatter_per_gene(endog, "Dcn", x.var = "Cell_type", y.var = "DCt", col.var = "Condition", theme = 18) +
  labs(y = "Delta CT") +
  scale_fill_discrete(name = "Cell type") +
  scale_x_discrete(labels = c("C2C12 GFP" = "C2C12", "FAP" = "FAP", "TA" = "Tibialis\nanterior")) +
  ggsave("Plots/Dcn_muscle_progenitors.tiff", width = 15, height = 10, units = "cm")
```


### Plot relative expression
#### Plot scatter
```{r}
plot_scatter(endog, x.var = "Cell_type", y.var = "rel_expr", col.var = "Condition") 
plot_scatter_per_gene(endog, "Dcn", x.var = "Cell_type", y.var = "rel_expr", col.var = "Condition", theme = 18) +
  labs(y = "Relative expression") +
  scale_fill_discrete(name = "Cell type") +
  scale_x_discrete(labels = c("C2C12 GFP" = "C2C12", "FAP" = "FAP", "TA" = "Tibialis\nanterior"))
```


plot_bar(endog, x.var = "Cell_type", y.var = "DCt", fill.var = "Condition") +
  labs(title = "Barplot all genes", y = "Delta CT", x = "Cell type")
plot_bar_per_gene(endog, "Dcn", "Cell_type", y.var = "DCt", fill.var = "Condition") +
  labs(title = "Barplot Decorin", y = "Delta CT", x = "Cell type")
plot_pointrange(endog, x.var = "Cell_type", y.var = "DCt", col.var = "Condition") +
  labs(title = "Pointrange all genes", y = "Delta CT", x = "Cell type")
plot_pointrange_per_gene(endog, "Dcn", x.var = "Cell_type", y.var = "DCt", col.var = "Condition") +
  labs(title = "Pointrange Decorin", y = "Delta CT", x = "Cell type")
```

## Plot relative expression

plot_scatter(endog, x.var = "Cell_type", y.var = "rel_expr", col.var = "Condition") +
  labs(title = "Scatterplot all genes", y = "Relative expression", x = "Cell type")
plot_pointrange(endog, x.var = "Cell_type", y.var = "rel_expr", col.var = "Condition") +
  labs(title = "Pointrange all genes", y = "Relative expression", x = "Cell type")
plot_bar_per_gene(endog, "Dcn", x.var = "Cell_type", y.var = "rel_expr", fill.var = "Condition") +
  labs(title = "Decorin", y = "Relative expression", x = "Cell type")
```

