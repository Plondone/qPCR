---
title: "qPCR viia7"
author: "Jordi Camps"
date: "27 september 2017"
output: html_document
---
#Load necessary packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(ggthemes)
library(RColorBrewer)
library(readxl)
library(dplyr)
library(tidyr)
library(Hmisc)
```

#Read data
```{r}
read_qpcr <- function(x) {
  qpcr_colnames <- c("Well Position", "Sample Name", "Target Name", "CT", "Ct Threshold", "Tm1", "Tm2", "Tm3")
  qpcr <- read_excel(x, sheet = 3, skip = 35, col_names = TRUE)
  qpcr <- qpcr[, qpcr_colnames]
  real_colnames <- c("Position_well", "Sample", "Gene", "CT", "CT_threshold", "Tm1", "Tm2", "Tm3")
  colnames(qpcr) <- real_colnames
  print(qpcr)
}
qpcr <- read_qpcr("Data/2017-09-20 124839 FAP-C2C12-Muscle qPCR validation MC.xls")

read_annotation <- function(x, col_types = "guess") {
  ann <- read_excel(x, col_names = TRUE)
  print(ann)
}
ann_samples <- read_annotation("Data/Annotations_124839_samples.xlsx")
ann_genes <- read_annotation("Data/Annotations_124839_primers.xlsx")
```

##Link annotation data with qpcr data
```{r}
join_and_clean_qpcr <- function(df, df.a = ann_samples, df.b = ann_genes, qpcr, by.a = "Sample", by.b = "Gene") {
  df <- df %>% 
    left_join(df.a, by = by.a) %>%
    left_join(df.b, by = by.b)
  df[ ,colnames(ann_samples)] <- lapply(df[ ,colnames(ann_samples)], factor)
  df[ , colnames(ann_genes)] <- lapply(df[ ,colnames(ann_genes)], factor)
  df$CT <- as.numeric(df$CT)
  print(df)
  str(df)
  assign('qpcr', df, envir = .GlobalEnv)
}
join_and_clean_qpcr(qpcr)
```


#Quality Control
```{r}
library(ggplot2)
par(mfrow=c(1,1))
hist(qpcr$CT, main = "CT values")

#Plot CT values for samples
ggplot(qpcr, aes(Sample, CT)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("CT values per sample")

#Plot CT values for primers
ggplot(qpcr, aes(Primer, CT)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("CT values per primer")

#Filter per sample
filter_sample <- function(df, sample_name) {
  df %>%
    filter(Sample == sample_name)
}
filter_sample(qpcr, "Sample 20")
filter_sample(qpcr, "Sample 23")
```

##Remove blanc
```{r}
remove_sample <- function(df, sample_name) {
  df <- df %>%
    filter(Sample != sample_name)
  assign("qpcr", df, envir = .GlobalEnv)
}
remove_sample(qpcr, "Sample 23")
hist(qpcr$CT, main = "CT after removal blanc")
```


##Set min and max CT
```{r}
#Change undetermined CT values to a baseline and remove contaminated wells
set_CT_min_max <- function(min = 10, max = 40) {
  qpcr$CT[qpcr$CT < min] <- NA
  qpcr$CT[is.na(qpcr$CT)] <- max
  qpcr$CT[qpcr$CT > max] <- max
  assign('qpcr', qpcr, envir=.GlobalEnv)
}
set_CT_min_max(10, 40)
hist(qpcr$CT, main = "CT after set baseline")
```


##List primers with more than one meltcurve and remove bad meltcurves
```{r}
list_double_meltcurves <- function(df) {
  df %>%
    arrange(Primer) %>%
    select(Primer, CT, Tm1, Tm2, Tm3) %>%
    filter(!is.na(Tm2))
}
list_double_meltcurves(qpcr)

remove_bad_meltcurves <- function() {
  qpcr$CT[!is.na(qpcr$Tm2)] <- NA
  assign('qpcr', qpcr, envir=.GlobalEnv)
}
remove_bad_meltcurves()
```

##Histogram CT values after QC
```{r}
hist(qpcr$CT, main = "CT after quality control")
```


#Quality control
##Seperate housekeeping genes
```{r}
plot_hkg <- function(x, main, col = "red") {
  par(mfrow = c(2, 2))
  plot(x, ylab = "CT", main = main)
  abline(h = c(gm_mean(x) - 1, gm_mean(x), gm_mean(x) + 1), col = col)
  hist(x, main = main)
  abline(v = c(gm_mean(x) - 1, gm_mean(x), gm_mean(x) + 1), col = col)
  boxplot(x, ylab = "CT", main = main)
  abline(h = c(gm_mean(x) - 1, gm_mean(x), gm_mean(x) + 1), col = col)
  }
gm_mean <- function(a, na.rm = TRUE){
  b <- !is.na(a)
   prod(a, na.rm = na.rm)^(1/sum(b))
}
remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs = c(.25, .75), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}

make_hkg <- function(df) {
  hkg <- df %>%
    filter(HKG == TRUE) %>%
    select(Primer, CT, Sample)
  assign('hkg', hkg, envir = .GlobalEnv)
}
make_hkg(qpcr)
```

##Plot QC housekeeping genes
```{r}
qc_hkg <- function(df) {
  a <- df %>%
    ggplot(aes(Sample, CT)) +
    geom_point() +
    facet_wrap(~Primer) +
    theme(axis.text.x = element_text(angle = 90)) +
    ggtitle("CT values HKG")
  print(a)
  
  b <- df %>%
    ggplot(aes(CT))+ 
    geom_histogram(binwidth = 1) +
    facet_wrap(~Primer) +
    theme(axis.text.x = element_text(angle = 90)) +
    ggtitle("CT values HKG")
  print(b)
  
  c <-  df %>%
    ggplot(aes(Primer, CT)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter()
    ggtitle("CT values HKG")
  print(c)
}
qc_hkg(hkg)
```

##Remove poor housekeeping genes
```{r}
remove_primer <- function(df, primer_name) {
  df <- df %>%
    filter(Primer != primer_name)
}
hkg <- remove_primer(hkg, "Rpl13a")
qc_hkg(hkg)
```


##Calculate average over housekeeping genes
```{r}
qc_mean_hkg <- function(df) {
  mean_hkg <- hkg %>%
    group_by(Sample) %>%
    summarise(CT_avg_hkg = mean(CT, na.rm = TRUE))#select housekeeping genes and tidy file per sample
  a <- mean_hkg %>%
    ggplot(aes(Sample, CT_avg_hkg)) +
    geom_point() +
    theme(axis.text.x = element_text(angle = 90)) +
    ggtitle("CT values avg HKG")
  print(a)
  
  b <- mean_hkg %>%
    ggplot(aes(CT_avg_hkg))+ 
    geom_histogram(binwidth = 1) +
    theme(axis.text.x = element_text(angle = 90)) +
    ggtitle("CT values avg HKG")
  print(b)
  
  c <-  mean_hkg %>%
    ggplot(aes("CT average HKG", CT_avg_hkg)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter() +
    ggtitle("CT values avg HKG")
  print(c)
  assign('mean_hkg', mean_hkg, envir = .GlobalEnv)
  
  hkg_post_removal <- remove_outliers(mean_hkg$CT_avg_hkg)
  par(mfrow = c(2, 2))
  boxplot(mean_hkg$CT_avg_hkg, main = "with outliers")
  hist(mean_hkg$CT_avg_hkg, main = "with outliers")
  boxplot(hkg_post_removal, main = "without outliers")
  hist(hkg_post_removal, main = "without outliers")
}
qc_mean_hkg(hkg)
```

##Remove outliers
```{r}
mean_hkg$CT_avg_hkg <- remove_outliers(mean_hkg$CT_avg_hkg)
```

#Delta CT
##Calculate Delta CT
```{r}
calculate_DCT <- function(df, cols) {
  DCT <- df %>%
    filter(HKG == FALSE) %>%
    select(Primer, CT, Sample, cols) %>%
    group_by(Sample) %>%
    left_join(mean_hkg, by = "Sample")
    
  DCT$CT[is.na(DCT$CT_avg_hkg)] <- NA #change all samples with bad hkg CT values to NA
  
  DCT <- DCT %>%
    mutate(DCt = CT_avg_hkg - CT) %>%
    arrange(Primer)
  assign('DCT', DCT, envir = .GlobalEnv)
}
calculate_DCT(qpcr, cols = c("Cell_type", "Condition" , "Mouse", "Passage"))
```

##Plot Delta CT
###Boxplot
```{r}
plot_boxplot <- function(df, x.var = "Sample", y.var = "DCt", fill.var, ncol = 6, nrow = 4) {
  ggplot(df, aes_string(x = x.var, y = y.var, fill = fill.var)) +
    geom_boxplot() +
    facet_wrap(~Primer, ncol = ncol, nrow = nrow) +
    ggtitle("Boxplot all genes") +
    theme_few()
  }
plot_boxplot(DCT, x.var = "Cell_type", fill.var = "Condition", ncol = 3, nrow = 5)
```

```{r, fig.width=3.5, fig.height=2.5}
plot_boxplot_per_gene <- function(df, gene, x.var = "Sample", y.var = "DCt", fill.var) {
  df %>%
    filter(Primer == gene) %>%
    ggplot(aes_string(x = x.var, y = y.var, fill = fill.var)) +
    geom_boxplot(outlier.shape = NA, position = position_dodge(0.8)) +
    geom_jitter(alpha = 0.5, position = position_dodge(0.8), size = 1) +
    ggtitle(gene) +
    theme_few()
}
plot_boxplot_per_gene(DCT, "Myog1", x.var = "Cell_type", fill.var = "Condition")
```

###Scatterplot
```{r}
plot_scatter <- function(df, x.var = "Sample", y.var = "DCt", col.var, ncol = 6, nrow = 4) {
  ggplot(df, aes_string(x = x.var, y = y.var, col = col.var)) +
    geom_point(position = position_dodge(0.3)) +
    facet_wrap(~Primer, ncol = ncol, nrow = nrow) +
    ggtitle("Scatterplot all genes") +
    theme_few()
  }
plot_scatter(DCT, x.var = "Cell_type", col.var = "Condition", ncol = 4, nrow = 4)
```

```{r, fig.width=3.5, fig.height=2.5}
plot_scatter_per_gene <- function(df, gene, x.var = "Sample", y.var = "DCt", col.var) {
  df %>%
    group_by_(col.var) %>%
    filter(Primer == gene) %>%
    ggplot(aes_string(x = x.var, y = y.var, col = col.var)) +
    geom_point(position = position_dodge(0.3)) +
    ggtitle(gene) +
    theme_few()
}
plot_scatter_per_gene(DCT, "Myog1", x.var = "Cell_type", col.var = "Condition")
```

###Barplot
```{r}
plot_bar <- function(df, x.var = "Sample", y.var = "DCt", fill.var, ncol = 6, nrow = 4) {
  df %>%
    group_by_(fill.var) %>%
    ggplot(aes_string(x = x.var, y = y.var, fill = fill.var)) +
    stat_summary(fun.y = mean, geom = "bar", position = position_dodge(0.9)) +
    stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = 0.1, position = position_dodge(0.9)) +
    facet_wrap(~Primer, ncol = ncol, nrow = nrow) +
    ggtitle("Barplot all genes") +
    theme_few()
  }
plot_bar(DCT, x.var = "Cell_type", fill.var = "Condition", ncol = 4, nrow = 4)
```

```{r, fig.width=3.5, fig.height=2.5}
plot_bar_per_gene <- function(df, gene, x.var = "Sample", y.var = "DCt", fill.var) {
  df %>%
    group_by_(fill.var) %>%
    filter(Primer == gene) %>%
    ggplot(aes_string(x = x.var, y = y.var, fill = fill.var)) +
    stat_summary(fun.y = mean, geom = "bar", position = position_dodge(0.9)) +
    stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = 0.1, position = position_dodge(0.9)) +
    ggtitle(gene) +
    theme_few()
}
plot_bar_per_gene(DCT, "Myog1", x.var = "Cell_type", fill.var = "Condition")
```


###Pointrange
```{r}
plot_pointrange <- function(df, x.var = "Sample", y.var = "DCt", col.var, ncol = 6, nrow = 4) {
   df %>%
    group_by_(col.var) %>%
    ggplot(aes_string(x = x.var, y = y.var, col = col.var)) +
    stat_summary(fun.y = mean, geom = "point", position = position_dodge(0.5)) +
    stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = 0.1, position = position_dodge(0.5)) +
    facet_wrap(~Primer, ncol = ncol, nrow = nrow) +
    labs(title="Pointrange of all genes", x = "Cell type", y = "Delta CT") +
    theme_few()
}
plot_pointrange(DCT, x.var = "Cell_type", col.var = "Condition", ncol = 5, nrow = 3)
```

```{r, fig.width=3.5, fig.height=2.5}
plot_pointrange_per_gene <- function(df, gene, x.var = "Sample", y.var = "DCt", col.var) {
  df %>%
    group_by_(col.var) %>%
    filter(Primer == gene) %>%
    ggplot(aes_string(x = x.var, y = y.var, col = col.var)) +
    stat_summary(fun.y = mean, geom = "point", position = position_dodge(0.3)) +
    stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = 0.1, position = position_dodge(0.3)) +
    labs(title = gene, x = "Cell type", y = "Delta CT") +
    theme_few()
}
plot_pointrange_per_gene(DCT, "Myog1", x.var = "Cell_type", col.var = "Condition")
```


###Violin plot
```{r}
plot_violin <- function(df, x.var = "Sample", y.var = "DCt", fill.var, ncol = 6, nrow = 4) {
  ggplot(df, aes_string(x = x.var, y = y.var, fill = fill.var)) +
    geom_violin(position = position_dodge(0.3)) +
    geom_dotplot(binaxis = "y", stackdir = "center", dotsize = 1, position = position_dodge(0.3)) +
    facet_wrap(~Primer, ncol = ncol, nrow = nrow) +
    ggtitle("Violinplot all genes") +
    theme_few()
  }
plot_violin(DCT, x.var = "Cell_type", fill.var = "Condition", ncol = 4, nrow = 4)
```

```{r, fig.width=3.5, fig.height=2.5}
plot_violin_per_gene <- function(df, gene, x.var = "Sample", y.var = "DCt", fill.var) {
  df %>%
    filter(Primer == gene) %>%
    ggplot(aes_string(x = x.var, y = y.var, fill = fill.var)) +
    geom_violin(position = position_dodge(0.3)) +
    geom_dotplot(binaxis = "y", stackdir = "center", dotsize = 1, position = position_dodge(0.3)) +
    ggtitle(gene) +
    theme_few()
}
plot_violin_per_gene(DCT, "Myog1", x.var = "Cell_type", fill.var = "Condition")
```