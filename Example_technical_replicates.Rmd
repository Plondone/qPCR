---
title: "MC technical replicates"
author: "Jordi Camps"
date: "31 oktober 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(qpcrviia7)
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggthemes)
library(RColorBrewer)
library(Hmisc)
```

## Import and prepare data
```{r}
#Import data
qpcr <- read_qpcr("Data/2017-10-05 FAP-C2C12-Muscle qPCR validation MC.xls")
#Import annotation
ann_samples <- read_annotation("Data/Annotations_samples_124839_technical_replicates.xlsx")
ann_genes <- read_annotation("Data/Annotations_primers_124839_technical_replicates.xlsx")
```

## Technical replicates
### List technical replicates above sd of 0.4
```{r}
list_bad_tech_rep(qpcr)
```

###Save by saving this function into qpcr dataframe
```{r}
qpcr <- qc_tech_rep(qpcr)
# Change remove Avg from col names
colnames(qpcr) <- c("Target", "Sample", "CT", "SD_CT", "Tm1", "SD_Tm1", "Tm2", "SD_Tm2")
```


## Merge and tidy
```{r}
join_and_clean_qpcr(qpcr)
```


## Quality control
### Primers and samples
```{r}
par(mfrow=c(1,1))
hist(qpcr$CT, main = "CT values")

#Plot CT values for samples
ggplot(qpcr, aes(Sample, CT)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("CT values per sample")

#Plot CT values for primers
ggplot(qpcr, aes(Gene, CT)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("CT values per primer")
```


### Remove blanc and 
```{r}
qpcr <- remove_blanc(qpcr)
hist(qpcr$CT, main = "CT after removal blanc")
```

### Split housekeeping genes and endogeneous genes
```{r}
split_genes(qpcr, CT = "CT")
```


### Set min and max CT
```{r}
endog <- set_min_max_CT(endog, CT = "CT", 10, 40)
hist(endog$CT, main = "CT after set baseline")
```




### Endogenous genes
#### List double meltcurve peaks
```{r}
list_double_meltcurves(endog, "CT")
remove_bad_meltcurves()
```




### Housekeeping genes
```{r}
#QC on housekeeping genes
qc_hkg(hkg)
```

### Remove Bad hkg primers
```{r}
hkg <- remove_primer(hkg, "Rpl13a")
```

### Calculate average of total HKG
```{r}
mean_hkg <- calculate_mean_hkg(hkg)
qc_mean_hkg(mean_hkg)
```

### Remove outliers
```{r}
mean_hkg$CT_avg_hkg <- remove_outliers(mean_hkg$CT_avg_hkg)
qc_mean_hkg(mean_hkg)
mean_hkg$CT_avg_hkg <- remove_outliers(mean_hkg$CT_avg_hkg)
```


## Calculate Delta CT
```{r}
calculate_DCT(endog, mean_hkg, cols = c("Cell_type", "Condition", "Mouse"))
```

## Plot Delta CT
```{r}
plot_scatter(endog, x.var = "Cell_type", y.var = "DCt", col.var = "Condition") 
plot_scatter_per_gene(endog, "Dcn", x.var = "Cell_type", y.var = "DCt", col.var = "Condition") 
```

## Plot relative expression
```{r}
plot_scatter(endog, x.var = "Cell_type", y.var = "rel_expr", col.var = "Condition") +
  labs(title = "Scatterplot all genes", y = "Relative expression", x = "Cell type")
```
